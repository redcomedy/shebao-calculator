# 五险一金计算器 - 部署和使用说明

## 1. Supabase 设置

### 1.1 创建 Supabase 项目

1. 访问 [Supabase](https://supabase.com) 并注册账号
2. 点击 "New Project" 创建新项目
3. 选择组织，输入项目名称（如：shebao-calculator）
4. 设置数据库密码（请记住此密码）
5. 选择地区（推荐选择 East Asia 或 Southeast Asia）
6. 点击 "Create new project"

### 1.2 获取 API 密钥

1. 项目创建后，进入项目控制台
2. 点击左侧菜单的 "Settings" > "API"
3. 你会看到以下两个密钥：
   - **Project URL**: 类似 `https://xxxxxxxx.supabase.co`
   - **anon public**: 匿名公钥
   - **service_role**: 服务端密钥（仅服务端使用）

### 1.3 创建数据库表

1. 点击左侧菜单的 "Table Editor"
2. 点击 "Create a new table"
3. 或者点击左侧菜单的 "SQL Editor"，然后点击 "New query"
4. 复制并执行项目中的 `supabase/schema.sql` 文件内容

### 1.4 设置 RLS（Row Level Security）

如果需要设置访问控制，可以执行以下 SQL：

```sql
-- 禁用 RLS（简单起见，生产环境建议启用并设置合适的策略）
ALTER TABLE cities DISABLE ROW LEVEL SECURITY;
ALTER TABLE salaries DISABLE ROW LEVEL SECURITY;
ALTER TABLE results DISABLE ROW LEVEL SECURITY;
```

## 2. 项目配置

### 2.1 配置环境变量

在项目根目录的 `.env.local` 文件中填入你的 Supabase 配置：

```env
NEXT_PUBLIC_SUPABASE_URL=https://你的项目ID.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的匿名密钥
SUPABASE_SERVICE_ROLE_KEY=你的服务端密钥
```

### 2.2 安装依赖

```bash
npm install
```

## 3. 本地开发

```bash
npm run dev
```

访问 http://localhost:3000

## 4. 项目结构说明

```
shebao/
├── app/                  # Next.js App Router 页面
│   ├── api/             # API 路由
│   │   ├── upload/      # 数据上传 API
│   │   ├── calculate/   # 计算逻辑 API
│   │   └── results/     # 结果查询 API
│   ├── upload/          # 数据上传页面
│   ├── results/         # 结果展示页面
│   └── page.tsx         # 主页
├── lib/                  # 工具函数
│   ├── supabase.ts      # Supabase 客户端
│   ├── database.ts      # 数据库操作
│   ├── calculator.ts    # 计算逻辑
│   └── excel.ts         # Excel 处理
├── types/                # TypeScript 类型定义
├── supabase/            # Supabase 相关文件
└── docs/                # 文档
```

## 5. 使用流程

### 5.1 上传城市标准数据

1. 准备 Excel 文件，包含以下列：
   - 城市名
   - 年份
   - 基数下限
   - 基数上限
   - 缴纳比例

2. 访问 `/upload` 页面
3. 点击"上传城市社保标准"区域的"选择文件"
4. 选择准备好的 Excel 文件
5. 等待上传成功提示

### 5.2 上传工资数据

1. 准备 Excel 文件，包含以下列：
   - 员工工号
   - 员工姓名
   - 年月（YYYYMM格式）
   - 工资金额

2. 在 `/upload` 页面
3. 点击"上传员工工资数据"区域的"选择文件"
4. 选择准备好的 Excel 文件
5. 等待上传成功提示

### 5.3 执行计算

1. 在 `/upload` 页面的"执行社保计算"区域
2. 选择城市和年份
3. 点击"执行计算"按钮
4. 等待计算完成提示

### 5.4 查看和导出结果

1. 访问 `/results` 页面
2. 可以使用筛选功能：
   - 按城市筛选（可多选）
   - 按年份筛选（可多选）
   - 按员工姓名搜索
3. 点击列标题可以对数据进行排序
4. 点击"导出 Excel"按钮下载结果

## 6. 部署到 Vercel（推荐）

### 6.1 准备工作

1. 将代码推送到 GitHub 仓库
2. 注册 [Vercel](https://vercel.com) 账号

### 6.2 部署步骤

1. 登录 Vercel，点击 "New Project"
2. 导入你的 GitHub 仓库
3. 配置项目：
   - Framework Preset: Next.js
   - Root Directory: 保持默认
4. 添加环境变量（与 `.env.local` 相同）
5. 点击 "Deploy"

### 6.3 自定义域名（可选）

1. 在 Vercel 项目设置中点击 "Domains"
2. 添加你的域名
3. 按照提示配置 DNS 记录

## 7. 常见问题

### Q: 上传 Excel 文件失败怎么办？

A: 请检查：
1. 文件格式是否为 `.xlsx` 或 `.xls`
2. 文件是否包含必需的列
3. 数据是否符合格式要求（如年月必须是6位数字）

### Q: 计算结果不准确？

A: 请检查：
1. 城市标准是否正确上传
2. 工资数据是否完整
3. 年份选择是否正确

### Q: 如何备份数据？

A: Supabase 会自动备份数据库，你也可以定期导出数据。

### Q: 是否支持多用户？

A: 当前版本是单用户版本，如需多用户支持需要添加认证系统。

## 8. 后续优化建议

1. 添加用户认证系统
2. 支持更多社保项目（养老、医疗、失业等分开计算）
3. 添加历史数据对比功能
4. 支持批量计算多个城市
5. 添加数据可视化图表