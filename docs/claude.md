# 五险一金计算器项目文档

## 项目概述
本项目是一个迷你的"五险一金"计算器Web应用，用于根据员工工资数据和城市社保标准计算公司应缴纳的社保公积金费用。

## 技术栈
- **前端框架**: Next.js
- **UI/样式**: Tailwind CSS
- **数据库/后端**: Supabase

## 数据库设计

### 1. cities (城市标准表)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键 |
| city_name | text | 城市名 |
| year | text | 年份 |
| base_min | int | 社保基数下限 |
| base_max | int | 社保基数上限 |
| rate | float | 简化的综合缴纳比例 (例如 0.15) |

### 2. salaries (员工工资表)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键 |
| employee_id | text | 员工工号 |
| employee_name | text | 员工姓名 |
| month | text | 年份月份 (YYYYMM格式) |
| salary_amount | int | 该月工资金额 |

### 3. results (计算结果表)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键 |
| employee_name | text | 员工姓名 |
| city_name | text | 城市名称 |
| year | text | 计算年份 |
| avg_salary | float | 年度月平均工资 |
| contribution_base | float | 最终缴费基数 |
| company_fee | float | 公司缴纳金额 |
| calculated_at | timestamp | 计算时间戳 |

## 核心业务逻辑

### 计算流程
1. 选择目标城市和年份
2. 从 salaries 表中读取指定年份的所有数据
3. 按员工姓名 (employee_name) 分组，计算每位员工的月平均工资：
   - 统计该员工该年度的月份数量
   - 汇总该员工该年度所有月份工资
   - 平均工资 = 总工资 / 月份数
4. 从 cities 表中获取指定城市的 base_min、base_max 和 rate
5. 确定每位员工的最终缴费基数：
   - 如果平均工资 < base_min，使用 base_min
   - 如果平均工资 > base_max，使用 base_max
   - 否则使用平均工资本身
6. 计算公司应缴纳金额：contribution_base × rate
7. 将结果（包含城市名、年份、计算时间戳）存入 results 表

## 前端页面设计

### 1. 主页 (/)
**功能**: 应用入口和导航中心
**布局**:
- 两个功能卡片（水平或垂直排列）
- 每个卡片包含标题和说明
- 卡片可点击跳转

**卡片内容**:
- **数据上传卡片**: 标题"数据上传"，跳转到 /upload
- **结果查询卡片**: 标题"结果查询"，跳转到 /results

### 2. 数据上传页 (/upload)
**功能**: 数据管理控制面板
**组件**:
- **上传城市标准按钮**: 选择本地Excel文件（cities），导入到 cities 表
- **上传工资数据按钮**: 选择本地Excel文件（salaries），导入到 salaries 表
- **执行计算面板**:
  - 城市选择下拉框
  - 年份选择下拉框
  - 执行计算按钮：触发核心计算逻辑，存储结果到 results 表

### 3. 结果展示页 (/results)
**功能**: 展示计算结果
**组件**:
- **筛选器**:
  - 城市筛选下拉框（多选）
  - 年份筛选下拉框（多选）
  - 员工姓名搜索框
- **数据表格**:
  - 自动从 results 表加载数据
  - 可排序的列（点击表头排序）
  - 分页功能
  - 显示所有字段（包括时间戳）
- **操作按钮**:
  - 导出为Excel按钮
  - 刷新数据按钮

## 开发任务清单 (TodoList)

### 环境搭建与项目初始化
- [ ] 创建 Next.js 项目
- [ ] 安装并配置 Tailwind CSS
- [ ] 安装 Supabase 客户端库
- [ ] 配置环境变量 (.env.local)
- [ ] 创建 Supabase 项目并设置认证

### 数据库设计与实现
- [ ] 在 Supabase 中创建 cities 表
- [ ] 在 Supabase 中创建 salaries 表
- [ ] 在 Supabase 中创建 results 表
- [ ] 设置表的主键和索引
- [ ] 准备测试数据（佛山城市标准和示例工资数据）

### 后端核心逻辑开发
- [ ] 创建数据库连接和配置文件
- [ ] 实现 cities 数据上传功能（解析 Excel）
- [ ] 实现 salaries 数据上传功能（解析 Excel）
- [ ] 实现城市和年份选择 API
- [ ] 实现按自然年计算平均工资函数（支持不足12个月）
- [ ] 实现缴费基数计算逻辑
- [ ] 实现公司费用计算函数
- [ ] 实现批量计算并存储结果的 API（包含时间戳）
- [ ] 实现数据筛选 API（城市、年份、姓名）
- [ ] 实现数据导出 API（Excel格式）

### 前端页面开发
- [ ] 创建布局组件和导航
- [ ] 开发主页（/）功能卡片
- [ ] 开发上传页面（/upload）
  - 城市标准文件上传组件
  - 工资数据文件上传组件
  - 城市和年份选择组件
  - 执行计算按钮
  - 上传进度提示
- [ ] 开发结果页面（/results）
  - 筛选器组件（城市、年份、姓名）
  - 数据表格组件（支持排序、分页）
  - 导出Excel按钮
  - 数据格式化（日期、金额）
  - 刷新数据功能

### 样式优化与用户体验
- [ ] 实现响应式设计
- [ ] 添加加载状态提示
- [ ] 添加错误处理和用户提示
- [ ] 优化表格样式和可读性
- [ ] 实现筛选器的交互体验
- [ ] 添加排序图标指示器
- [ ] 优化移动端表格展示
- [ ] 添加页面过渡动画

### 测试与部署
- [ ] 编写单元测试
- [ ] 进行集成测试
- [ ] 测试城市和工资数据上传功能
- [ ] 测试多城市计算逻辑准确性
- [ ] 测试筛选和排序功能
- [ ] 测试Excel导出功能
- [ ] 测试不足12个月工资的计算
- [ ] 部署到 Vercel 或其他平台
- [ ] 配置自定义域名（如需要）

### 项目文档与维护
- [ ] 编写 API 文档
- [ ] 编写用户使用指南
- [ ] 准备示例数据文件（cities.xlsx, salaries.xlsx）
- [ ] 设置项目备份策略
- [ ] 代码审查和优化
- [ ] 编写Excel文件格式说明文档

## 注意事项
1. 所有计算保留两位小数
2. 金额单位使用人民币（元）
3. 日期格式统一为 YYYYMM
4. 错误处理要友好且明确
5. 页面加载性能优化
6. Excel文件格式：
   - cities.xlsx：城市名、年份、基数下限、基数上限、缴纳比例
   - salaries.xlsx：员工工号、员工姓名、年月（YYYYMM）、工资金额
7. 计算时间戳自动记录（UTC时间）
8. 支持同员工多年份数据计算
9. 筛选功能支持多选和组合